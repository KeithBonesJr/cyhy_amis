---
# tasks file for cyhy_dashboard

#
# Install curl and unzip; they are needed by cyhy_core/var/load_places.sh
#
- name: Install pip
  package:
    name: python-pip
    state: latest

- name: Install curl and unzip
  package:
    name:
      - build-essential
      - curl
      - unzip
      - apt-transport-https
      - ca-certificates
      - gnupg2
      - software-properties-common
    state: latest

- name: Grab GitHub OAuth token from S3
  local_action:
    module: aws_s3
    bucket: ncats-cyhy-secrets
    object: github_oauth_token.yml
    dest: /tmp/github_oauth_token.yml
    mode: get
  become: no

- name: Load GitHub OAuth token from YML file
  local_action:
    module: include_vars
    file: /tmp/github_oauth_token.yml
  become: no

#
# Grab the cyhy-core code
#
- name: Create the /tmp/cyhy-core directory
  file:
    path: /tmp/cyhy-core
    state: directory

- name: Download and untar the cyhy-core tarball
  unarchive:
    src: "https://api.github.com/repos/jsf9k/cyhy-core/tarball/develop?access_token={{ github_oauth_token }}"
    dest: /tmp/cyhy-core
    remote_src: yes
    extra_opts:
      - "--strip-components=1"


- name: Install cyhy-core
  command: pip install /tmp/cyhy-core

#
# Grab the ncats-webd code
#

- name: Create the /tmp/ncats-webd directory
  file:
    path: /tmp/ncats-webd
    state: directory

- name: Download and untar the webd tarball
  unarchive:
    src: "https://api.github.com/repos/jsf9k/ncats-webd/tarball/develop?access_token={{ github_oauth_token }}"
    dest: /tmp/ncats-webd
    remote_src: yes
    extra_opts:
      - "--strip-components=1"

- name: Install webd
  command: pip install /tmp/ncats-webd

#
# Grab the ncats-webui code
#

- name: Create the /tmp/ncats-webui directory
  file:
    path: /tmp/ncats-webui
    state: directory

- name: Download and untar the webui tarball
  unarchive:
    src: "https://api.github.com/repos/jsf9k/ncats-webui/tarball/develop?access_token={{ github_oauth_token }}"
    dest: /tmp/ncats-webui
    remote_src: yes
    extra_opts:
      - "--strip-components=1"


#
# Cleanup
#
- name: Delete /tmp/cyhy-core
  file:
    path: /tmp/cyhy-core
    state: absent

- name: Delete /tmp/ncats-webd
  file:
    path: /tmp/ncats-webd
    state: absent

- name: Delete /tmp/ncats-webui
  file:
    path: /tmp/ncats-webui
    state: absent
