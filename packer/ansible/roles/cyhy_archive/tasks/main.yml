---
# tasks file for cyhy_archive

- name: Grab GitHub OAuth token from S3
  local_action:
    module: aws_s3
    bucket: ncats-cyhy-secrets
    object: github_oauth_token.yml
    dest: /tmp/github_oauth_token.yml
    mode: get
  become: no

- name: Load GitHub OAuth token from YML file
  local_action:
    module: include_vars
    file: /tmp/github_oauth_token.yml
  become: no

- name: Create the /var/cyhy/scripts directory
  file:
    path: /var/cyhy/scripts
    state: directory

- name: Download cyhy_archive.sh from GitHub
  get_url:
    url: "https://raw.githubusercontent.com/jsf9k/cyhy-core/develop/var/cyhy_archive.sh"
    headers:
      Authorization: "token {{ github_oauth_token }}"
    dest: /var/cyhy/scripts/cyhy_archive.sh
    mode: 0755

# Clean up
- name: Delete local copy of GitHub OAuth token
  local_action:
    module: file
    path: /tmp/github_oauth_token.yml
    state: absent
  become: no
