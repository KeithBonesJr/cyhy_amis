---
# tasks file for mongo
- name: Get mongodb-org GPG key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 0C49F3730359A14518585931BC711F9BA15703C6

- name: Copy sources list for mongodb-org (official MongoDB package repo)
  copy:
    src: mongodb-org-3.4.list
    dest: /etc/apt/sources.list.d
    mode: 0644

- name: Update the cache with the mongodb-org goodness
  apt:
    update_cache: yes

- name: Install mongo
  apt:
    name: mongodb-org=3.4.17
  notify:
    - Enable mongo

- name: Configure mongo service to run after cloud-config
  lineinfile:
    dest: /lib/systemd/system/mongod.service
    regexp: ^After=
    state: present
    line: After=network.target cloud-config.service

# Mongo docs recommend running via numactl on NUMA hosts
# https://docs.mongodb.com/manual/administration/production-notes/#mongodb-and-numa-hardware
- name: Start mongod via numactl
  lineinfile:
    dest: /lib/systemd/system/mongod.service
    regexp: ^ExecStart=/usr/bin/mongod
    state: present
    line: ExecStart=/usr/bin/numactl --interleave=all /usr/bin/mongod --config /etc/mongod.conf

- name: Install pip
  apt:
    name: python-pip
    state: latest

# pymongo is needed for ansible mongodb_user module
- name: Install pymongo via pip
  pip:
    name: pymongo
    state: latest
