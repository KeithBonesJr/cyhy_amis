---
# tasks file for bod_docker

#
# Load mongo users and passwords into a variable
#
- name: Grab mongo users and passwords from S3
  local_action:
    module: aws_s3
    bucket: ncats-cyhy-secrets
    object: mongo_users.yml
    dest: /tmp/mongo_users.yml
    mode: get
  become: no

- name: Load mongo users and passwords from YML file
  local_action:
    module: include_vars
    file: /tmp/mongo_users.yml
    name: mongo_users
  become: no

#
# Chown the /var/cyhy directory so it is owned by the cyhy user
#
- name: chown the /var/cyhy directory
  file:
    path: /var/cyhy
    owner: cyhy
    group: cyhy
    state: directory
    recurse: yes

#
# Add the cyhy user to the docker group
#
- name: Add the cyhy user to the docker group
  user:
    name: cyhy
    groups:
      - docker
    append: yes


#
# orchestrator secrets
#
- name: Create the secrets directories for orchestrator and cyhy-mailer
  file:
    path: "{{ item }}"
    owner: cyhy
    group: cyhy
    state: directory
  loop:
    - /var/cyhy/orchestrator/secrets
    - /var/cyhy/cyhy-mailer/secrets

- name: Create the orchestrator credentials file to allow reading the cyhy database
  copy:
    dest: /var/cyhy/orchestrator/secrets/cyhy_read_creds.yml
    owner: cyhy
    group: cyhy
    mode: 0440
    content: |
      version: '1'

      database:
        name: cyhy
        uri: mongodb://reporter:{{ mongo_users.other_users | selectattr("user", "eq", "reporter") | map(attribute="password") | first }}@{{ mongo_host }}:27017/cyhy

- name: Create the orchestrator credentials file to allow reading the scan database
  copy:
    dest: /var/cyhy/orchestrator/secrets/scan_read_creds.yml
    owner: cyhy
    group: cyhy
    mode: 0440
    content: |
      version: '1'

      database:
        name: scan
        uri: mongodb://scan-reader:{{ mongo_users.other_users | selectattr("user", "eq", "scan-reader") | map(attribute="password") | first }}@{{ mongo_host }}:27017/scan

- name: Create the orchestrator credentials file to allow writing to the scan database
  copy:
    dest: /var/cyhy/orchestrator/secrets/scan_write_creds.yml
    owner: cyhy
    group: cyhy
    mode: 0440
    content: |
      version: '1'

      database:
        name: scan
        uri: mongodb://scan-writer:{{ mongo_users.other_users | selectattr("user", "eq", "scan-writer") | map(attribute="password") | first }}@{{ mongo_host }}:27017/scan

- name: Create a temporary directory to store the orchestrator AWS secrets
  local_action:
    module: file
    path: /tmp/secrets/aws
    state: directory
  become: no

- name: Grab the orchestrator AWS credentials from S3
  local_action:
    module: aws_s3
    bucket: ncats-bod-18-01-secrets
    object: "orchestrator_secrets/aws/{{ item }}"
    dest: "/tmp/secrets/aws/{{ item }}"
    mode: get
  become: no
  loop:
    - config
    - credentials

- name: Copy the orchestrator AWS secrets
  copy:
    src: /tmp/secrets/aws
    dest: /var/cyhy/orchestrator/secrets
    owner: cyhy
    group: cyhy
    mode: 0750

- name: Delete local copy of orchestrator secrets
  local_action:
    module: file
    path: /tmp/secrets
    state: absent
  become: no


#
# cyhy-mailer secrets
#
# The cyhy-mailer container does not run as root, so the creds files
# need to be globally readable.  docker-compose does allow one to
# specify the uid, gid, and mode of the secrets files, but that only
# works in swarm mode.
#
- name: Copy the cyhy-mailer database credentials
  copy:
    src: /var/cyhy/orchestrator/secrets/cyhy_read_creds.yml
    remote_src: yes
    dest: /var/cyhy/cyhy-mailer/secrets/database_creds.yml
    owner: cyhy
    group: cyhy
    mode: 0444

- name: Create a temporary directory to store the cyhy-mailer AWS SMTP credentials
  local_action:
    module: file
    path: /tmp/secrets/smtp
    state: directory
  become: no

- name: Grab the cyhy-mailer AWS SMTP credentials from S3
  local_action:
    module: aws_s3
    bucket: ncats-bod-18-01-secrets
    object: cyhy-mailer_secrets/smtp_creds.yml
    dest: /tmp/secrets/smtp/smtp_creds.yml
    mode: get
  become: no

- name: Copy the cyhy-mailer AWS SMTP credentials
  copy:
    src: /tmp/secrets/smtp/smtp_creds.yml
    dest: /var/cyhy/cyhy-mailer/secrets/smtp_creds.yml
    owner: cyhy
    group: cyhy
    mode: 0444

- name: Delete local copy of cyhy-mailer secrets
  local_action:
    module: file
    path: /tmp/secrets
    state: absent
  become: no


#
# Create cron jobs for scanning and the sending of reports
#
- name: Create a cron job for BOD 18-01 scanning
  cron:
    name: "BOD 18-01 scanning"
    minute: 0
    hour: 4
    weekday: 6
    user: cyhy
    job: "cd /var/cyhy/orchestrator && /usr/local/bin/docker-compose up -d"

- name: Create a cron job for sending BOD 18-01 reports
  cron:
    name: "Sending BOD 18-01 reports"
    minute: 0
    hour: 12
    weekday: 1
    user: cyhy
    job: "cd /var/cyhy/cyhy-mailer && /usr/local/bin/docker-compose up -d"


#
# Add users to the cyhy group
#
- name: Load users from YML file
  local_action:
    module: include_vars
    file: ../../../../terraform/scripts/user_ssh_setup.yml
    name: ssh_users
  become: no

- name: Add known users to the cyhy group
  user:
    name: "{{ item }}"
    groups:
      - cyhy
    append: yes
  loop: "{{ ssh_users.users | map(attribute='name') | list }}"
