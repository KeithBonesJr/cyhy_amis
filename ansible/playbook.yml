---
- hosts: localhost
  gather_facts: yes
  check_mode: no
  tasks:
  - name: Add public ip addresses to an dynamic inventory
    add_host:
      name: "{{ host }}"
      groups: "{{ host_groups.split(',') }}"

  - wait_for:
      port: 22
      host: "{{ host }}"
      search_regex: OpenSSH
    delegate_to: "{{ bastion_host }}"
    when: bastion_host is defined

  - wait_for:
      port: 22
      host: "{{ host }}"
      search_regex: OpenSSH
    when: bastion_host is not defined

- hosts: all
  gather_facts: no
  check_mode: no
  become: no
  tasks:
    - name: Install python 2.7
      raw: >
        test -e /usr/bin/python ||
        (
          (test -e /usr/bin/apt-get && (apt-get -y update && apt-get install -y python)) ||
          (test -e /usr/bin/yum && (yum makecache fast && yum install -y python))
        )
      args:
        creates: /usr/bin/python

- hosts: mongo
  name: Configure MongoDB
  become: yes
  become_method: sudo
  roles:
    - mongo
